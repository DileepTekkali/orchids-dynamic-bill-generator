<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BillMaker - Create Bill</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-amber-50/30 to-orange-50/20 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="flex items-center gap-4 mb-8">
            <a href="/" class="p-2 border border-slate-200 rounded-full hover:bg-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
            </a>
            <h1 class="text-2xl font-bold text-slate-800">Create New Bill</h1>
        </div>

        <div class="space-y-6">
            <!-- Customer Details -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Customer Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Customer Name</label>
                        <input type="text" id="customerName" required class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Customer Phone</label>
                        <input type="text" id="customerPhone" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500">
                    </div>
                </div>
            </div>

            <!-- Items -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Items</h2>
                    <button type="button" onclick="addItem()" class="text-sm font-bold text-amber-600 hover:text-amber-700 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Item
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-slate-500 text-sm border-b border-slate-100">
                                <th class="pb-2 font-semibold">Description</th>
                                <th class="pb-2 font-semibold w-24">Qty</th>
                                <th class="pb-2 font-semibold w-32">Price</th>
                                <th class="pb-2 font-semibold w-32">Total</th>
                                <th class="pb-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="items-body">
                            <!-- Items will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Summary & Signature -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">Signature</h2>
                    <div id="drop-zone" class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center cursor-pointer hover:bg-slate-50 transition-colors">
                        <input type="file" id="signature-input" accept="image/*" class="hidden">
                        <div id="signature-empty">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-400 mb-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            <p class="text-sm text-slate-500">Click or drag to upload signature</p>
                        </div>
                        <div id="signature-preview-container" class="hidden relative">
                            <img id="signature-preview" class="max-h-32 mx-auto">
                            <button type="button" onclick="removeSignature()" class="absolute -top-2 -right-2 bg-red-100 text-red-600 p-1 rounded-full hover:bg-red-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 space-y-3">
                    <div class="flex justify-between text-slate-600">
                        <span>Subtotal</span>
                        <span id="subtotal">₹0.00</span>
                    </div>
                    <div class="flex justify-between items-center gap-4 text-slate-600">
                        <span>Tax (%)</span>
                        <input type="number" id="taxRate" value="0" oninput="calculateTotals()" class="w-20 px-2 py-1 rounded border border-slate-200 text-right focus:outline-none focus:ring-1 focus:ring-amber-500">
                    </div>
                    <div class="flex justify-between items-center gap-4 text-slate-600">
                        <span>Discount (₹)</span>
                        <input type="number" id="discount" value="0" oninput="calculateTotals()" class="w-20 px-2 py-1 rounded border border-slate-200 text-right focus:outline-none focus:ring-1 focus:ring-amber-500">
                    </div>
                    <div class="border-t border-slate-100 pt-3 flex justify-between items-center font-bold text-xl text-slate-800">
                        <span>Grand Total</span>
                        <span id="grandTotal" class="text-amber-600">₹0.00</span>
                    </div>
                </div>
            </div>

            <button onclick="saveBill()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg shadow-amber-500/25 hover:shadow-amber-500/40 transition-all text-lg">
                Generate & Save Bill
            </button>
        </div>
    </div>

    <script>
        let items = [];
        let signatureUrl = '';

        function addItem() {
            const id = Date.now();
            items.push({ id, description: '', quantity: 1, price: 0 });
            renderItems();
        }

        function removeItem(id) {
            items = items.filter(item => item.id !== id);
            renderItems();
        }

        function updateItem(id, field, value) {
            const item = items.find(i => i.id === id);
            if (item) {
                item[field] = field === 'description' ? value : parseFloat(value) || 0;
                renderItems();
            }
        }

        function renderItems() {
            const tbody = document.getElementById('items-body');
            tbody.innerHTML = items.map(item => `
                <tr class="border-b border-slate-50">
                    <td class="py-3">
                        <input type="text" value="${item.description}" oninput="updateItem(${item.id}, 'description', this.value)" placeholder="Item description" class="w-full bg-transparent focus:outline-none">
                    </td>
                    <td class="py-3">
                        <input type="number" value="${item.quantity}" oninput="updateItem(${item.id}, 'quantity', this.value)" class="w-full bg-transparent focus:outline-none">
                    </td>
                    <td class="py-3">
                        <input type="number" value="${item.price}" oninput="updateItem(${item.id}, 'price', this.value)" class="w-full bg-transparent focus:outline-none">
                    </td>
                    <td class="py-3 font-semibold text-slate-700">
                        ₹${(item.quantity * item.price).toFixed(2)}
                    </td>
                    <td class="py-3 text-right">
                        <button onclick="removeItem(${item.id})" class="text-red-400 hover:text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-slate-400 italic">No items added yet</td></tr>`;
            }
            calculateTotals();
        }

        function calculateTotals() {
            const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            
            const taxAmount = subtotal * (taxRate / 100);
            const grandTotal = subtotal + taxAmount - discount;
            
            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `₹${Math.max(0, grandTotal).toFixed(2)}`;
        }

        // Signature Handling
        const dropZone = document.getElementById('drop-zone');
        const sigInput = document.getElementById('signature-input');

        dropZone.onclick = () => sigInput.click();

        sigInput.onchange = (e) => {
            if (e.target.files && e.target.files[0]) {
                const formData = new FormData();
                formData.append('signature', e.target.files[0]);
                
                fetch('/api/upload-signature', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (data.filepath) {
                        signatureUrl = data.filepath;
                        document.getElementById('signature-preview').src = data.filepath;
                        document.getElementById('signature-empty').classList.add('hidden');
                        document.getElementById('signature-preview-container').classList.remove('hidden');
                    }
                });
            }
        };

        function removeSignature() {
            signatureUrl = '';
            document.getElementById('signature-empty').classList.remove('hidden');
            document.getElementById('signature-preview-container').classList.add('hidden');
        }

        async function saveBill() {
            const billData = {
                billNumber: 'BILL-' + Date.now().toString().slice(-6),
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                items: items,
                subtotal: items.reduce((sum, item) => sum + (item.quantity * item.price), 0),
                taxRate: parseFloat(document.getElementById('taxRate').value) || 0,
                discount: parseFloat(document.getElementById('discount').value) || 0,
                grandTotal: parseFloat(document.getElementById('grandTotal').textContent.replace('₹', '')),
                billDate: new Date().toISOString(),
                signature: signatureUrl
            };

            if (!billData.customerName || items.length === 0) {
                alert('Please enter customer name and add at least one item');
                return;
            }

            const res = await fetch('/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(billData)
            });

            if (res.ok) {
                window.location.href = '/';
            }
        }

        // Initial Item
        addItem();
    </script>
</body>
</html>
